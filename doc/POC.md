## Proof of Concept (PoC) по розгортанню GitOps-системи на k3d.

# Встановлення k3d (Linux/macOS)
```
curl -s https://raw.githubusercontent.com/k3d-io/k3d/main/install.sh | bash
```

# Встановлення ArgoCD (https://argo-cd.readthedocs.io/en/stable/)
```
kubectl create namespace argocd
kubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml

#Перевірка
kubectl get all -n argocd
kubectl get po -n argocd -w
```

# Доступ до The Argo CD API Server через Port Forwarding
```
kubectl port-forward svc/argocd-server -n argocd 8080:443
```
Примітка. Треба використовувати https та прийняти самопідписаний сертифікат.

# Пароль в ArgoCD
```
kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" |base64 -d; echo
```
Вводимо login: admin та пароль з команди вище.

# Створення App
Вибираємо "NEW APP".
Вводимо довільне ім’я додатку в поле "Application name".
В випадаючому списку поля Project Name вибрати "default".
В розділі "SOURCE" по замовчуванню git. Введемо URL репозиторію, який містить маніфести для розгортання. В даному випадку це буде хелм чарт, тобто пакет маніфестів, що являє собою групу об'єктів для kubernetes і нашого додатку. 
У полі "path" введемо шлях до каталогу "helm".
У розділі "DESTINATION" вкажемо кластер kubernetes і простір імен, де буде
розгорнуто додаток. Вкажемо локальний кластер та новий Namespace "demo", argocd
автоматично визначить параметри додатку, використовуючи маніфести, які знаходяться в
репозиторії.
У розділі Політика синхронізації вкажемо, як додаток буде синхронізуватися з
git репозиторіям. Важливо вказати argo, щоб створив новий Namespace, так як в Хелм цю
функцію по замовченню прибрали.
Натисніть кнопку Створити, щоби створити аплікації. Після створення програми Арго
автоматично виявлять хелм чарт та підготують до розгортання демо аплікації на вказаному
кластері. У вказаному просторі імен ми можемо переглянути деталі та конфігурації програми, натиснувши на неї у списку.
Argocd надає графічний інтерфейс для візуалізації стану розгортання та архітектури
додатків, розгорнутих за допомогою цієї системи. Графічний вигляд дає ієрархічне
уявлення про компоненти програми, їх розгортання і поточний стан у кластері
Kubernetes.

# Синхронізація
Щоб синхронізувати програму ми виконуємо наступні дії. У вікні
відомостей про програму ми натиснемо кнопку Синхронізувати, оберемо компоненти та режим
синхронізації, який ми хочемо використовувати, і натиснемо кнопку
Синхронізувати. Почнеться процес синхронізації, і ми зможемо відстежувати його
хід у вікні Деталі програми. Після завершення ми можемо перевірити правильність розгортання програми, перевіривши її статус у кластері. Коли виконується синхронізація в аркуші дії, порівнюється бажаний стан з визначеним у гіт репозиторію з поточним станом, які у кластері Kubernetes. Якщо між двома станами є відмінності, Арго застосує необхідні зміни, щоб привести додаток до бажаного стану.

# Test
Port Forward для доступу до сервісу і api gateway.
```
kubectl port-forward -n demo svc/envoy-demo-eg-0d68e7be 8081:80
```
В додатковій вкладці терміналу виконуємо curl спочатку на сервіс Амбасадор та отримуємо
відповідь версії додатку. Далі завантажуємо довільну картинку, збережемо її локально, а
після передамо як пейлоад на сервіс.
```
curl -H "Host: demo.example.com" -F 'image=@/tmp/g.png' http://localhost:8081/api
```
Результат - успішна конвертація зображення в asciart.
